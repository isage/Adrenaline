name: Build Check
on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    # container: grayjack1/adrenaline:latest # Official VitaSDK Docker image
    steps:
    - uses: actions/checkout@v5

    - name: Install Dependencies
      run: sudo apt-get install build-essential cmake pkgconf libreadline8 libusb-0.1 libgpgme11 libarchive-tools fakeroot python3 wget

    - name: Pre-setup VITASDK
      run: |
        echo "VITASDK=/usr/local/vitasdk" >> $GITHUB_ENV
        echo "/usr/local/vitasdk/bin" >> $GITHUB_PATH
        echo $GITHUB_ENV
        echo $GITHUB_PATH

    - name: Setup VITASDK
      run: |
        git clone https://github.com/vitasdk/vdpm
        cd vdpm
        ./bootstrap-vitasdk.sh
        ./install-all.sh

    - name: Pre-setup PSPSDK
      run: |
        sudo mkdir -p /usr/local/pspdev
        echo "PSPDEV=/usr/local/pspdev" >> $GITHUB_ENV
        echo "/usr/local/pspdev/bin" >> $GITHUB_PATH
        echo $GITHUB_ENV
        echo $GITHUB_PATH

    - name: Setup PSPSDK
      run: |
        wget https://github.com/pspdev/pspdev/releases/latest/download/pspdev-ubuntu-latest-x86_64.tar.gz
        sudo tar -xzf pspdev-ubuntu-latest-x86_64.tar.gz -C /usr/local/

    - name: Build eCFW
      run: make -C cef

    - name: Build VITA
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build

    # - name: Upload VPK
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: vita-homebrew
    #     path: build/*.vpk